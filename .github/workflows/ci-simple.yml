name: CI Simple

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-14  # macOS Sonoma
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'  # Stable, not RC
        
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: List available simulators
      run: |
        echo "=== Available Simulators ==="
        xcrun simctl list devices available | grep -i iphone || echo "No iPhone simulators found"
        echo ""
        echo "=== All iOS Devices ==="
        xcrun simctl list devices | grep -i "iOS\|iPhone" | head -10
      
    - name: Build project (generic SDK)
      run: |
        # Build without specific simulator - just use SDK
        xcodebuild clean build \
          -scheme FelixPersonalHub \
          -sdk iphonesimulator \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -allowProvisioningUpdates
          
    - name: Run tests (if simulator available)
      run: |
        # Try to find and use any available simulator
        SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | sed 's/.*(\([^)]*\)).*/\1/' | xargs)
        if [ -n "$SIMULATOR" ]; then
          echo "Using simulator: $SIMULATOR"
          xcodebuild test \
            -scheme FelixPersonalHub \
            -destination "platform=iOS Simulator,id=$SIMULATOR" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Tests skipped"
        else
          echo "No simulator available, skipping tests"
        fi

